<!DOCTYPE html>
<html lang="en">

    <head>
        {% include 'common/header.html' %}
        <title>RD內部開案申請單</title>

        <link rel="stylesheet" href="{{ url_for('static', filename='/css/main.css') }}" />
        <link rel="stylesheet" href="{{ url_for('static', filename='/css/internal_project_form.css') }}" />
        <link rel="stylesheet" href="{{ url_for('static', filename='/css/side_menu.css') }}" />

        <script src="{{ url_for('static', filename='/js/dom-to-image.js') }}"></script>
        <script src="{{ url_for('static', filename='/js/bootstrap.js') }}"></script>

    </head>

    <body id="root">

        <!-- 上方主標題欄 -->
        {% include 'common/title_bar.html' %}


        <!-- 左邊側邊導覽列選單區 -->
        {% include 'common/side_menu.html' %}

       


        <!-- 內容群組區背景 -->
        <div id="div-content-group">
            <!-- 表單標題 -->
            <div id="function-bar">
            </div>

            <div id="id-table-bg">
                <div id="form-title-text"><b>RD內部開案申請單</b></div>

                <table id="id-table-form">

                    <!-- 表單標題 -->
                    <thead id="table-head">
                        <tr>
                            <th colspan="2" rowspan="1" id="lab-submit-member" class="cls-c2-r1">申請人</th>
                            <th colspan="2" rowspan="1" id="txt-submit-member" class="cls-c2-r1">{{ USER_CNAME }}</th>
                            <th colspan="2" rowspan="1" id="lab-form-date" class="cls-c2-r1">申請日期</th>
                            <th colspan="2" rowspan="1" id="txt-form-date" class="cls-c2-r1"></th>
                            <th colspan="2" rowspan="1" id="lab-form-code" class="cls-c2-r1">單據編號</th> 
                            <th colspan="4" rowspan="1" id="txt-form-no" class="cls-c4-r1"></th>
                            <th colspan="2" rowspan="1" id="lab-form-no"   class="cls-c2-r1">專案代號</th>
                            <th colspan="4" rowspan="1" id="txt-project-no"   class="cls-c4-r1"></th>
                        </tr>
                    </thead>

                <!-- 表單內容 ☐ ☑ -->
                <tbody id="table-body">

                    <tr>
                        <th colspan="3" rowspan="9" id="lab-base-explain" class="cls-c3-r9">立案產品 </br> 基本說明</th>
                       
                    <tr>
                        <th colspan="3" rowspan="1" id="lab-project-name" class="cls-c3-r1">專案名稱✱</th>
                        <th colspan="14" rowspan="1" id="txt-project-name" class="cls-c14-r1">
                            <input type="text" id="input-project-name" value="">
                        </th>
                    </tr>
                    <tr>
                        <th colspan="3" rowspan="1" id="lab-product-explan" class="cls-c3-r1">專案說明✱</th>
                        <th colspan="14" rowspan="1" id="txt-product-explan" class="cls-c14-r1">
                            <input type="text" id="input-project-describe" value="">
                        </th>
                    </tr>
                    <tr>
                      
                    </tr>
                    <tr>
                        <th colspan="3" rowspan="1" id="lab-spec" class="cls-c3-r1">規格需求說明✱</th>
                        <th colspan="14" rowspan="1" id="txt-spec" class="cls-c14-r1">
                            <input type="text" id="input-spec" value="">
                        </th>
                    </tr>
                    <tr>
                       
                       
                    </tr>
                    <tr>
                        <th colspan="3" rowspan="1" id="lab-project-finish" class="cls-c3-r1">目標專案完成日</th>
                        <th colspan="14" rowspan="1" id="txt-project-finish" class="cls-c14-r1">
                            <input type="date" id="input-project-finish" value="">
                        </th>
                    </tr>
                    <tr>
                        <th colspan="3" rowspan="1" id="lab-target-cost" class="cls-c3-r1">目標成本</th>
                        <th colspan="14" rowspan="1" id="txt-target-cost" class="cls-c14-r1">
                            <input type="text" id="input-target-cost" value="">
                        </th>
                    </tr>
                    <tr>
                       

                    </tr>

                     <!-- 上傳檔案 -->
                     <tr>
                        <th colspan="3" rowspan="2" id="lab-attach-file"   class="cls-c3-r2">附加檔案✱</th>
                        
                        <th colspan="17" rowspan="1" id="empty-submit" class="cls-c17-r1">
                            <form action="" method=post enctype=multipart/form-data id="upload-form">
                                <p><input type=file name=file id="btn-file">
                                <button id="btn-upload" class="layui-btn" lay-event="form-submit" title="上傳檔案">
                                    <i class="layui-icon layui-icon-upload-drag"></i>上傳檔案
                                </button>
                            </form>
                        </th>
                        
                    </tr>
                    <tr>
                        <!-- <th colspan="3" rowspan="1" id="lab-attach-file"   class="cls-c3-r1">附加檔案✱</th> -->
                        <th colspan="17" rowspan="1" id="file-list" class="cls-c17-r1">
                            <div id="fileUL">
                            </div>
                        <th>
                    </tr>

                    
                    
                    
                    <tr>
                        <th colspan="18" rowspan="1" id="lab-symbol" class="cls-c18-r1">
                            <div id="txt-symbol">✱ 為必填欄位</div>
                        </th>
                        <th colspan="2" rowspan="1" id="lab-submit-button" class="cls-c2-r1">
                            <button id="btn-submit" class="layui-btn layui-btn-normal" title="送出資料">
                                <i class="layui-icon layui-icon-email"></i>確認
                            </button>
                           
                            <!-- <button id="btn-test" class="cls-send-btn" title="送出資料">
                                <i class="layui-icon layui-icon-email"></i>TEST
                            </button> -->
                            
                        </th>
                    </tr>
                    
                    <!--<tr id="help-axis">-->
                    <td colspan="1" class="c-base" id="c-1"></td>
                    <td colspan="1" class="c-base" id="c-2"></td>
                    <td colspan="1" class="c-base" id="c-3"></td>
                    <td colspan="1" class="c-base" id="c-4"></td>
                    <td colspan="1" class="c-base" id="c-5"></td>
                    <td colspan="1" class="c-base" id="c-6"></td>
                    <td colspan="1" class="c-base" id="c-7"></td>
                    <td colspan="1" class="c-base" id="c-8"></td>
                    <td colspan="1" class="c-base" id="c-9"></td>
                    <td colspan="1" class="c-base" id="c-10"></td>

                    <td colspan="1" class="c-base" id="c-11"></td>
                    <td colspan="1" class="c-base" id="c-12"></td>
                    <td colspan="1" class="c-base" id="c-13"></td>
                    <td colspan="1" class="c-base" id="c-14"></td>
                    <td colspan="1" class="c-base" id="c-15"></td>
                    <td colspan="1" class="c-base" id="c-16"></td>
                    <td colspan="1" class="c-base" id="c-17"></td>
                    <td colspan="1" class="c-base" id="c-18"></td>
                    <td colspan="1" class="c-base" id="c-19"></td>
                    <td colspan="1" class="c-base" id="c-20"></td>
                    <!--</tr>-->

                </tbody>

            </table>      

        </div>

               <!-- 彈出指派任務視窗 -->
               <template id="task-template">

                <div id="task-window-bg">
    
                    <table id="task-win-table">
    
                        <tbody id="task-table-body">
                            <tr>
                                <!-- <th colspan="2" rowspan="1" id="lab-project-no" class="tab-c2-r1">專案案號</th>
                                <th colspan="3" rowspan="1" id="txt-project-no" class="tab-c3-r1">
                                   
                                </th> -->
                            </tr>
                            <tr>
                                <!-- <th colspan="2" rowspan="1" id="lab-project-name" class="tab-c2-r1">產品名稱</th>
                                <th colspan="3" rowspan="1" id="txt-project-name" class="tab-c3-r1">
                                    
                                </th> -->
                            </tr>
                            <tr>
                                <th colspan="2" rowspan="1" id="lab-assign" class="tab-c2-r1">指派人員</th>
                                <th colspan="2" rowspan="1" id="txt-assign" class="tab-c2-r1">
                                    <select id="select-assign">
                                        <option></option>
                                    </select>
                                </th>
                                <th colspan="1" rowspan="1" id="txt-assign" class="tab-c1-r1">
                                    <!-- <button id="btn-add" class="layui-btn" title="加入" onclick="newElement();"> -->
                                    <button id="btn-add" class="layui-btn" title="加入">
                                        <i class="layui-icon layui-icon-addition"></i>加入
                                    </button>
                                </th>
                            </tr>
                            <tr>
                                <th colspan="5" rowspan="1" id="txt-list" class="tab-c5-r1">
                                    <div id="member-ul"></div>
                                    <!--
                                    <ul id="myUL"></ul>
                                    -->
                                </th>
                            </tr>
                            <!-- 預估RD 專案開始時間 -->
                            <tr>
                                <th colspan="2" rowspan="1" id="lab-project-start" class="tab-c2-r1">預計執行開始時間</th>
                                <th colspan="3" rowspan="1" id="txt-project-start" class="tab-c3-r1">
                                    <input type="date" id="input-project-start" value="">
                                </th>
                            </tr>
                        
                            <!-- 預估RD 專案結束時間 -->
                            <tr>
                                <th colspan="2" rowspan="1" id="lab-project-end" class="tab-c2-r1">預計執行完畢時間</th>
                                <th colspan="3" rowspan="1" id="txt-project-end" class="tab-c3-r1">
                                    <input type="date" id="input-project-end" value="">
                                </th>
                            </tr>
                        
                        </tbody>
                    </table>
                </div>
            </template>


              <!-- 程式區 -->
        <script>



            $("#txt-form-date").text(
                addDate()
            );

                function addDate() {
                    var today = new Date();
                    var nowDD = String(today.getDate()).padStart(2, '0');
                    var nowMM = String(today.getMonth() + 1).padStart(2, '0');
                    var nowYYYY = today.getFullYear();
                    strNowDate = nowYYYY + "-" + nowMM + "-" + nowDD;
                    return strNowDate;
            }
            var memberMap = new Map();
            var mailMap = new Map();
            var groupMap = new Map();
          
            //帶入專案代號
            async function get_internal_project_no()
            {
                let url = "http://{{ DOMAIN_PATH }}/api/v0/db/internal_project_no/";
                const res = await fetch(url, {
                                        method: 'GET',                                       
                                        headers: { 'Content-Type': 'application/json charset = utf-8' }
                            });
                return await res.json();
            }

            let promiseP = get_internal_project_no();
            promiseP.then((response)=>
            {
                console.log(response)
                document.getElementById("txt-project-no").textContent = response;
                
            });
        
            //帶入表單編號
            async function get_internal_project_form_no()
            {
                let url = "http://{{ DOMAIN_PATH }}/api/v0/db/internal_project_form_no/";
                const res = await fetch(url, {
                                        method: 'GET',                                       
                                        headers: { 'Content-Type': 'application/json charset = utf-8' }
                            });
                return await res.json();
            }

            let promiseF = get_internal_project_form_no();
            promiseF.then((response)=>
            {
                console.log(response)
                document.getElementById("txt-form-no").textContent = response;
                
            });

            // 渲染樣式
            function addIconforBtn(mode) {
                var btn1 = $(".layui-layer-btn .layui-layer-btn0");
                var btn2 = $(".layui-layer-btn .layui-layer-btn1");
                // 警告
                if (mode == 0) {
                    btn1.css({ "background-color": "#ff0066", "border-color": "#555555", "font-size": "18px" });
                    btn2.css({ "background-color": "#ffe6f0", "border-color": "#555555", "font-size": "18px" });
                }
                // 詢問
                if (mode == 1) {
                    btn1.css({ "background-color": "#1E9FFF", "border-color": "#555555", "font-size": "18px" });
                    btn2.css({ "background-color": "#e6f4ff", "border-color": "#555555", "font-size": "18px" });
                }
            }

                // 按下表單(同意)按紐
                $("#btn-submit").click(async () => {
                            
                            //#region 卡控是否上傳附件
                            let project_no = $("#txt-project-no").text();
                            let url = "http://{{ DOMAIN_PATH }}/api/v0/db/find/upload_file/?project_no="  + project_no ;
                            // console.log(url)
                            const response = await fetch(url);
                            const res = await response.json();
                            //console.log(res['data'].length)

                            if(res['data'].length == 0)
                            {
                                layer.msg("未上傳附件，請確認");
                                return;
                            }
                            
                            //#endregion

                            layer.open({
                                type       : 1,
                                skin       : 'layui-layer-molv', //layui-layer-rim
                                resize     : true,
                                shadeClose : false,
                                shade      : [0.7, '#000'],
                                closeBtn   : 2,
                                offset     : 'auto',
                                anim       : 5,
                                area       : ['600px', '500px'],
                                title      : ['指派任務', 'font-size:24px;background-color:#1E9FFF;'],
                                btn        : ['指派', '取消'],
                                content    : $('#task-template').html(),
                                success: function (layero, index) {
                                    addIconforBtn(1);


                                    let promiseGetMember = getMemberFun();
                                    promiseGetMember.then((response) => {
                                        console.log(response);
                                        var strPersonOptions = '';
                                        strPersonOptions += '<option disabled selected value="">請選擇一個人員</option>';
                                        for (var i = 0; i < response['data']['msg'].length; i++) {

                                            memberMap.set(response['data']['msg'][i]['mail'],  response['data']['msg'][i]['cname'] );
                                            mailMap.set(  response['data']['msg'][i]['cname'], response['data']['msg'][i]['mail'] );
                                            groupMap.set( response['data']['msg'][i]['cname'], response['data']['msg'][i]['group'] );

                                            strPersonOptions += '<option value="' + response['data']['msg'][i]['mail'] + '">' + response['data']['msg'][i]['cname'] + '</option>';
                                        }
                                        document.getElementById("select-assign").innerHTML = strPersonOptions;
                                    });
                                    console.log(selectNameList);

                                    // 按下增加人員按鈕
                                    document.querySelector("#btn-add").addEventListener('click', function(ev) {
                                        var sel_member_name = $("#select-assign").val();
                                        //alert(sel_member_name);
                                        console.log(sel_member_name);
                                        console.log(memberMap.get(sel_member_name));

                                        if (selectNameList.includes(memberMap.get(sel_member_name))) {
                                            console.log('目標字串在原始字串中');
                                            layer.msg('該名人員重複了');
                                        } else {
                                            newMemberElement(memberMap.get(sel_member_name));
                                        }
                                    });

                                
                                },
                                yes: function (index, layero) {

                                 

                                    /////////////////// 取得執行開始及結束時間
                                    var select_startDate = document.getElementById('input-project-start').value;
                                    var select_enddate   = document.getElementById('input-project-end'  ).value;
                                    //console.log(select_startDate)
                                    if(select_startDate.length == 0) {
                                        layer.msg('請選擇預計執行開始時間!');
                                        layer.close();
                                        return;
                                    }
                                    if(select_enddate.length == 0) {
                                        layer.msg('請選擇預計執行結束時間!');
                                        layer.close();
                                        return;
                                    }


                                    /////////////////// 取得指派人員數量資訊
                                    var selectPersonList = document.getElementById('member-ul');
                                    //var selectListItems  = selectPersonList.getElementsByTagName('li');
                                    var selectListItems = document.getElementsByClassName('list-member-item');
                                    console.log(selectListItems);

                                    var memberList = [];
                                    console.log(selectListItems.length);

                                    if( selectListItems.length <1) {
                                        layer.msg('無法送出訊息,請選擇一個人員加入名單!');
                                        layer.close();
                                    }

                                    
                                 
                                

                                    for (var i = 0; i < selectListItems.length; i++) {
                                        var itemValue  = (selectListItems[i].innerText);
                                        var strCName = itemValue.substring(0,3);
                                        console.log('----------------------');
                                        console.log(strCName);
                                        console.log(mailMap.get(strCName));
                                        var memberObj = new Object(); 
                                        memberObj['cName']                  = strCName;
                                        memberObj['mail']                   = mailMap.get(strCName);
                                        memberObj['group']                  = groupMap.get(strCName);
                                        memberObj['callback']               = false;
                                        if(groupMap.get(strCName) == "ee")
                                        {
                                            memberObj['task'] = "Hardware Design";
                                            memberObj['mile_stone'] = "MCU Design";
                                        }
                                        else if(groupMap.get(strCName) == "ld")
                                        {
                                            memberObj['task'] = "架構規劃";
                                            memberObj['mile_stone'] = "資料研讀";
                                        }                                    
                                        memberObj['status']                 = "待辦中";
                                        memberObj['actual_date']            = "";
                                        memberObj['reason']                 = "";
                                        memberObj['memo']                   = "";
                                        memberObj['form_type']              = "內部開案單";
                                        memberObj['expected_start_date']    = $("#input-project-start").val();
                                        memberObj['expected_end_date']      = $("#input-project-end").val();
                                        memberObj['form_no']                = "{{NEW_PROJECT_MODEL['form_no']}}";
                                        memberList.push(memberObj);
                                    }
                                    //console.log(memberList);



                                     //新開案form 寫入一筆
                                    let promise_post = post_internal_project_form();
                                                promise_post.then((response) => {
                                                console.log(response);
                                    });




                                    //寫入new_project_task
                                    async function post_new_project_task() {

                                        let uri = "http://{{ DOMAIN_PATH }}/api/v0/db/new_project_task/";
                                        let objParam = {
                                            "form_no"              : $("#txt-form-no").text(),
                                            "project_no"           : $("#txt-project-no").text(),
                                            "project_name"         : $("#input-project-name ").val(),
                                            "product_name"         : "",
                                            "product_no"           : "",
                                            "bu"                   : 'RD',
                                            "member_list"          : memberList,        
                                            "expected_start_date"  : $("#input-project-start").val(),
                                            "expected_finish_date" : $("#input-project-end").val(),
                                            "status"               : "",
                                            "task"                 : "",
                                            "mile_stone"           : "",
                                            "actual_date"          : "",
                                            "reason"               : "",
                                            "memo"                 : "", 
                                            "actual_date"          : "",
                                            "back_reason"          : "",
                                            "back_memo"            : "",
                                        };
                                        let jsonParam = JSON.stringify(objParam);
                                        console.log(jsonParam);
                                        const res = await fetch(uri, {
                                            method  : 'post',
                                            body    : jsonParam,
                                            headers : { 'Content-Type': 'application/json; charset=utf-8' }
                                        });
                                        return await res.json();

                                    } 
                                    let promise_new_project_task = post_new_project_task();
                                    promise_new_project_task.then((response) => {

                                    }); //promise_new_project_task

                                    insert_form_flow(true);

                                    // 發給多人
                                    promiseList = [];
                                    for( var m = 0; m < memberList.length; m++ ) {
                                        console.log("發mail");
                                        console.log(memberList[m]['mail']);

                                        async function send_assign_mail() {
                                            let url = "http://{{ DOMAIN_PATH }}/api/v0/send/internal_project_task/";
                                            let objParam = {
                                                "product_no"    : "",
                                                "project_no"    : $("#txt-project-no").text(),
                                                "product_name"  : "",
                                                "project_name"  : $("#input-project-name").val(),
                                                "project_describe"  : $("#input-project-describe").val(),
                                                "form_no"       : $("#txt-form-no").text(),
                                                "sender"        : "{{ ACCOUNT }}",
                                                "receiver"      : memberList[m]['mail'],
                                                "project_start" : $("#input-project-start").val(),
                                                "project_end"   : $("#input-project-end").val()
                                            };
                                            let jsonParam = JSON.stringify(objParam);
                                            const res = await fetch(url, {
                                                method  : 'POST',
                                                body    : jsonParam,
                                                headers : { 'Content-Type': 'application/json charset = utf-8' }
                                            });
                                            return await res.json();
                                        }
                                        var promise_send_assign_mail = send_assign_mail();
                                        promiseList.push(promise_send_assign_mail);
                                    }

                                    Promise.all(promiseList).then(value => {
                                        console.log(value);
                                        layer.msg("指派作業完成");
                                        page_to_form_list();
                                    });


                                }
                            });
                            });
           


               

                function sleep(ms) {
                        return new Promise(resolve => setTimeout(resolve, ms));
                }


                //按下退回
                $("#btn-reject").click(function () {
                    layer.open({
                        type: 1,
                        skin: 'layui-layer-molv', //layui-layer-rim
                        resize: true,
                        shadeClose: false,
                        shade: [0.7, '#000'],
                        closeBtn: 2,
                        offset: 'auto',
                        anim: 5,
                        area: ['600px', '400px'],
                        title: ['詢問', 'font-size:24px;background-color:#ff0066;'],
                        btn: ['退回', '取消'],
                        content: $('#taskback-template-edit').html(),//'<div style="padding: 15px; font-size: 22px; font-weight: bold;">{{ USER }}，您是否確定要退回指派？<br><br><div id="view-txt-msg"></div></div>',
                        success: function (layero, index) {
                            addIconforBtn(0);
                        },
                        yes: function (index, layero) {

                            param = {
                                "project_no"              : $("#txt-project-no").val(),
                                "project_name"         : $("#txt-project-name").val(),
                                "member_list"         : "",
                                "expected_start_date"  : $("#input-project-start").val(),
                                "expected_finish_date" : $("#input-project-end").val(),
                                "status"               : "待辦中",
                                "task"                 : "",
                                "mile_stone"           : "",
                                "actual_date"          : "",
                                "back_reason"          : $("#select-taskback-reason").val(),
                                "back_memo"            : $("#input-taskback-memo").val(),
                            }


                            //將task退回資料寫入
                            var settings = {
                                "url": "http://{{ DOMAIN_PATH }}/api/v0/db/new_technology_task/",
                                "method": "POST",
                                "timeout": 0,
                                "headers": {"Content-Type": "application/json"},
                                "data": JSON.stringify(param),
                            };

                            $.ajax(settings).done(function (response) {
                                //console.log(response);
                                layer.close(index);
                            });


                            //寫入表單流程紀錄
                            insert_form_flow(false);

                            //發送退回mail
                            async function send_back_mail() {
                                //let uri = "http://{{ DOMAIN_PATH }}/page/v0/logout/";
                                let uri = "http://{{ DOMAIN_PATH }}/api/v0/send/new_technology_task/back/"
                                let objParam = {
                                    "project_no"    : $("#txt-project-no").val(),
                                    "project_name"  : $("#txt-project-name").val(),
                                    "form_no"       :"{{NEW_PROJECT_MODEL['form_no']}}",
                                    "back_reason"   :$("#select-taskback-reason").val(),
                                    "back_memo"     :$("#input-taskback-memo").val(),
                                    "sender"        : "{{ ACCOUNT }}",
                                    "receiver"      : "{{RECEIVER}}",
                                    "cc"            : "{{RECEIVER}}",
                                };
                                let jsonParam = JSON.stringify(objParam);
                                console.log(jsonParam)
                                const res = await fetch(uri, {
                                    method: 'post',
                                    body: jsonParam,
                                    headers: { 'Content-Type': 'application/json; charset=utf-8' }
                                });
                                return await res.json();
                            }
                            let promisePost = send_back_mail();
                            promisePost.then((response) => {
                                console.log(response);
                                layer.close(index);
                                page_to_form_list();
                                
                            });

                         
                        }
                    });
                });


            

            //取回人員名單
            async function getMemberFun() {
                let uri = "http://{{ DOMAIN_PATH }}/api/v0/db/data/get/member/by_organize/";
                let objParam = {
                    organize: "硬體設計部",
                };
                //console.log(objParam);
                let jsonParam = JSON.stringify(objParam);
                console.log(jsonParam);
                const res = await fetch(uri, {
                    method: 'post',
                    body: jsonParam,
                    headers: { 'Content-Type': 'application/json; charset=utf-8' }
                });
                return await res.json();
            }
           

                        var list = document.querySelector('ul');
                        var selectNameList = [];
           
                    function newMemberElement(strMemberCName) {
                        var li = document.createElement("div");
                        li.className = "list-member-item";
                        li.id = strMemberCName;
                        if(strMemberCName != null) {
                            // 文字
                            var divobj = document.createElement("div");
                            divobj.className = "text-member";
                            var t = document.createTextNode(strMemberCName);
                            //t.id = strMemberCName;
                            divobj.appendChild(t);
                            li.appendChild(divobj);
                            // 刪除按鈕
                            var btn3 = document.createElement("button");
                            btn3.className = "cls-delete-btn-member";
                            
                            var bt3 = document.createTextNode("刪除");
                            btn3.appendChild(bt3);
                            li.appendChild(btn3);
                            btn3.onclick = function() {
                                var div = this.parentElement;
                                div.remove();
                                //console.log(this.parentElement.id);
                                var itemToRemove = this.parentElement.id;
                                var index = selectNameList.indexOf(itemToRemove);
                                if (index !== -1) {
                                    selectNameList.splice(index, 1);
                                }
                            }
                            document.getElementById("member-ul").appendChild(li);
                            selectNameList.push(strMemberCName);
                        }

                    }


                    //寫入表單流程紀錄
                    async function insert_form_flow(status) {
                       
                       let uri = "http://{{ DOMAIN_PATH }}/api/v0/db/form_flow/"
                       let objParam = {
                           "form_no"           : $("#txt-form-no").text(),
                           "project_no"        : $("#txt-project-no").text(),
                           "type"              : "internal_project",
                           "fs_code"           : "fsintg102",
                           "action"            : "指派",
                           "status"            : status?"指派":"退回",
                           "memo"              : status ?  "" :  $("#select-taskback-reason").val() + "," + $("#input-taskback-memo").val(),
                           "user"              : "{{ USER_CNAME }}"
                       };
                     
                       let jsonParam = JSON.stringify(objParam);
                      
                       const res = await fetch(uri, {
                           method: 'post',
                           body: jsonParam,
                           headers: { 'Content-Type': 'application/json; charset=utf-8' }
                       });
                       return await res.json();
                   }


                     
                    function fileElement(strFileName) {

                            var li = document.createElement("div");
                            li.className = "list-file-item";
                            li.id = strFileName;
                            if(strFileName != null) {
                                // 文字
                                var divobj = document.createElement("div");
                                divobj.className = "text-filename";
                                var t = document.createTextNode(strFileName);
                            
                                divobj.appendChild(t);
                                li.appendChild(divobj);
                                // 刪除按鈕
                                var btn3 = document.createElement("button");
                                btn3.className = "cls-delete-btn-file";

                                var bt3 = document.createTextNode("刪除");
                                btn3.appendChild(bt3);
                                li.appendChild(btn3);
                                btn3.onclick = function() {
                                    var div = this.parentElement;
                                    console.log(this.parentElement)
                                    div.remove();
                                    remove_file(this.parentElement.id).then((response)=>{                                               
                                        layer.msg(response['msg'])
                                    });
                                
                                    var itemToRemove = this.parentElement.id;
                                    var index = selectNameList.indexOf(itemToRemove);
                                    if (index !== -1) {
                                        selectNameList.splice(index, 1);
                                    }
                                }
                                document.getElementById("fileUL").appendChild(li);
                                selectNameList.push(strFileName);
                            }

                    }//fileElement


                    

                    function sleep(ms) {
                        return new Promise(resolve => setTimeout(resolve, ms));
                    }

                      //切畫面至project_list
                        async function page_to_form_list() {
                                    await sleep(1000);
                                    location.replace('http://{{ DOMAIN_PATH }}/page/v0/form_list/');
                                    //window.location.href = 'http://{{ DOMAIN_PATH }}/page/v0/new_technology_review/';
                        };


                    // 按上傳檔按鈕                
                $("#upload-form").submit(function (event) {
                    event.preventDefault();
                    var formData = new FormData(this);

                    $.ajax({
                        url: "http://{{ DOMAIN_PATH }}/api/v0/spec/upload/?project_no=" + $("#txt-project-no").text(),
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            //檔案上傳成功!
                            console.log(response);
                            var responseObject = JSON.parse(response);
                            var msg = responseObject.msg;
                            if( responseObject.result == 'ok') {
                                console.log(msg);
                                layer.msg(msg);
                                $('#btn-submit').removeClass("layui-btn-disabled").attr("disabled", false);

                                // 成功上傳檔案處理列表
                                //alert(responseObject['data']['file_name']);
                                fileElement(responseObject['data']['file_name']);

                            }else {
                               
                                if($("#txt-project-no").text() == "")
                                {
                                    layer.msg('未選擇BU，上傳失敗');
                                }
                                console.log(msg);
                                layer.msg(msg);
                                $('#btn-submit').addClass("layui-btn-disabled").attr("disabled", true);
                            }
                        },
                        error: function (xhr, status, error) {
                            if($("#txt-project-no").text() == "")
                            {
                                    layer.msg('未選擇BU，上傳失敗');
                            }
                            //layer.msg("上傳失敗");
                            $('#btn-submit').addClass("layui-btn-disabled").attr("disabled", true);
                        }
                    });
                });

                async function remove_file(file_name){
                    let url = "http://{{ DOMAIN_PATH }}/api/v0/spec/remove/?project_no=" + $("#txt-project-no").text() + "&file_name=" + file_name;
                    const res = await fetch(url, {
                            method: 'get',                            
                            headers: { 'Content-Type': 'application/json; charset=utf-8' }
                    });
                    return await res.json();
                } //remove_file


                   //寫入new_project_task
                async function post_new_project_task(objParam) {

                                let uri = "http://{{ DOMAIN_PATH }}/api/v0/db/new_project_task/";                                 
                                let jsonParam = JSON.stringify(objParam);
                                console.log(jsonParam);
                                const res = await fetch(uri, {
                                    method  : 'post',
                                    body    : jsonParam,
                                    headers : { 'Content-Type': 'application/json; charset=utf-8' }
                                });
                                    return await res.json();

                };

                        //寫入internal_project_form
                        async function post_internal_project_form() {
                            
                                //let uri = "http://{{ DOMAIN_PATH }}/page/v0/logout/";
                                let uri = "http://{{ DOMAIN_PATH }}/api/v0/db/internal_project_form/"
                                let objParam = {                                   
                                    "project_no":             $("#txt-project-no").text(),                                   
                                    "form_no":                $("#txt-form-no").text(),
                                    "form_type":              '內部開案單',
                                    "project_name":           $("#input-project-name ").val(),                                  
                                    "project_describe":       $("#input-project-describe").val(),                                   
                                    "spec_describe":          $("#input-spec ").val(),                                 
                                    "expected_finished_date": $("#input-project-finish").val(),
                                    "cost":                   $("#input-target-cost").val(),
                                    "estimate_date":          $("#input-due-day").val(),
                                    "apply_date":             $("#txt-form-date").text(),
                                    "status":                 "未進行",
                                    "member_cname":           "{{ USER_CNAME }}"
                                };
                                let jsonParam = JSON.stringify(objParam);
                                console.log(jsonParam)
                                const res = await fetch(uri, {
                                    method: 'post',
                                    body: jsonParam,
                                    headers: { 'Content-Type': 'application/json; charset=utf-8' }
                                });
                                return await res.json();
                            }
                              

                    function addDate() {
                        var today = new Date();
                        var nowDD = String(today.getDate()).padStart(2, '0');
                        var nowMM = String(today.getMonth() + 1).padStart(2, '0');
                        var nowYYYY = today.getFullYear();
                        strNowDate = nowYYYY + "-" + nowMM + "-" + nowDD;
                        return strNowDate;
                    }






        </script>

    </body>

</html>